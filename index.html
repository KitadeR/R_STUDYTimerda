<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>勉強時間記録</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f7f7f7;
    }
    h1, h2, h3 {
      color: #333;
    }
    .input-area, .subject-management, #summaryTable, .add-record {
      background: #fff;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    label {
      display: inline-block;
      width: 80px;
      margin-right: 10px;
    }
    input[type="text"], input[type="datetime-local"], select {
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 200px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 8px 15px;
      margin-top: 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background-color: #45a049;
    }
    ul {
      list-style-type: none;
      padding-left: 0;
    }
    ul li {
      background: #fff;
      margin-bottom: 5px;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer; /* カーソルをポインターに変更してクリック可能であることを示す */
    }
    ul li button {
      background-color: #e74c3c;
      padding: 5px 10px;
      font-size: 12px;
    }
    ul li button:hover {
      background-color: #c0392b;
    }
    #dailyTotal {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    #studyChart {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      max-width: 800px;
      max-height: 400px;
    }
    .record-control {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
    }
    #startTimeDisplay {
      margin-left: 10px;
      font-size: 1em;
      color: #555;
    }
    #summaryTable table {
      width: 100%;
      border-collapse: collapse;
    }
    #summaryTable th, #summaryTable td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    #summaryTable th {
      background-color: #f0f0f0;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, orderBy, Timestamp, onSnapshot, query, deleteDoc, doc, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAQGXHwTEcg-xGKvFi1V-vIPJwS-PR4_7Y",
      authDomain: "studytimerda.firebaseapp.com",
      projectId: "studytimerda",
      storageBucket: "studytimerda.firebasestorage.app",
      messagingSenderId: "528673388784",
      appId: "1:528673388784:web:34b5826cd213ee6a0c6a35"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);
    const recordsCollection = collection(db, 'studyRecords');
    const subjectsCollection = collection(db, 'subjects');
    const auth = getAuth(app);

    let allRecords = []; // ← グローバルで宣言

    document.addEventListener('DOMContentLoaded', () => {
      const subjectInput = document.getElementById('subject');
      const startTimeInput = document.getElementById('startTime');
      const endTimeInput = document.getElementById('endTime');
      const recordButton = document.getElementById('recordButton');
      const addSubjectInput = document.getElementById('addSubject');
      const addSubjectButton = document.getElementById('addSubjectButton');
      const subjectList = document.getElementById('subjectList');
      const recordList = document.getElementById('recordList');
      const showMoreRecordsButton = document.getElementById('showMoreRecordsButton');
      let showingAll = false;

      const dailyTotalDiv = document.getElementById('dailyTotal');
      const studyChartCtx = document.getElementById('studyChart').getContext('2d');
      const startButton = document.createElement('button');
      startButton.textContent = '開始';
      const endButton = document.createElement('button');
      endButton.textContent = '終了';
      const pauseButton = document.createElement('button'); // 追加
      pauseButton.textContent = '休憩';
      const resumeButton = document.createElement('button'); // 追加
      resumeButton.textContent = '休憩終了';
      resumeButton.style.display = 'none';
      const startTimeDisplay = document.createElement('span');
      startTimeDisplay.id = 'startTimeDisplay';
      let currentStartTime;
      let elapsedTimerId = null;
      let pauseStartTime = null; // 休憩開始時刻
      let pauseTimerId = null;   // 休憩タイマー
      let totalPausedMs = 0;     // 休憩合計(ms)
      let currentPausedMs = 0;   // 今回の休憩(ms)

      // ▼▼ ローカルストレージから復元 ▼▼
      if (localStorage.getItem('studyTimer_currentStartTime')) {
        currentStartTime = new Date(localStorage.getItem('studyTimer_currentStartTime'));
        if (!isNaN(currentStartTime)) {
          // 休憩合計復元
          totalPausedMs = parseInt(localStorage.getItem('studyTimer_totalPausedMs')) || 0;
          // 休憩開始時刻復元
          if (localStorage.getItem('studyTimer_pauseStartTime')) {
            pauseStartTime = new Date(localStorage.getItem('studyTimer_pauseStartTime'));
            pauseButton.style.display = 'none';
            resumeButton.style.display = '';
            // 休憩タイマー再開
            if (pauseTimerId) clearInterval(pauseTimerId);
            pauseTimerId = setInterval(() => {
              updateDisplay();
            }, 1000);
          } else {
            pauseStartTime = null;
            pauseButton.style.display = '';
            resumeButton.style.display = 'none';
            // 経過時間タイマー再開
            if (elapsedTimerId) clearInterval(elapsedTimerId);
            elapsedTimerId = setInterval(updateDisplay, 1000);
          }
          startTimeDisplay.textContent = `開始: ${currentStartTime.toLocaleTimeString()}　経過: 0秒`;
        }
      }
      if (localStorage.getItem('studyTimer_subject')) {
        subjectInput.value = localStorage.getItem('studyTimer_subject');
      }
      // ▲▲ ローカルストレージから復元 ▲▲

      const summaryTableDiv = document.getElementById('summaryTable');

      let studyChart;

      const inputAreaDiv = document.querySelector('.input-area > div:first-child').parentNode;
      const recordControlDiv = document.createElement('div');
      recordControlDiv.classList.add('record-control');
      recordControlDiv.appendChild(startButton);
      recordControlDiv.appendChild(endButton);
      recordControlDiv.appendChild(pauseButton);   // 追加
      recordControlDiv.appendChild(resumeButton);  // 追加
      recordControlDiv.appendChild(startTimeDisplay);
      inputAreaDiv.appendChild(recordControlDiv);

      // ★ 修正: ここで summaryTableDiv を追加するのは一度だけにします
      if (!document.getElementById('summaryTable')) {
        const newSummaryTableDiv = document.createElement('div');
        newSummaryTableDiv.id = 'summaryTable';
        document.body.appendChild(newSummaryTableDiv);
        newSummaryTableDiv.innerHTML = '<h2>科目別・日付別 合計勉強時間</h2><table><thead><tr><th>日付</th><th>科目</th><th>合計時間</th></tr></thead><tbody id="summaryTableBody"></tbody></table>';
      }
      const summaryTableBody = document.getElementById('summaryTableBody');

      // 勉強時間を追加するための要素を取得
      const addSubjectSelect = document.getElementById('addSubjectSelect');
      const addStartTime = document.getElementById('addStartTime');
      const addEndTime = document.getElementById('addEndTime');
      const addRecordButton = document.getElementById('addRecordButton');
      const addPausedMinutes = document.getElementById('addPausedMinutes'); // 追加

      // 科目リストをドロップダウンに表示
      const qSubjects = query(subjectsCollection, orderBy('name'));
      onSnapshot(qSubjects, (snapshot) => {
        addSubjectSelect.innerHTML = '<option value="">選択してください</option>';
        snapshot.forEach(docSnap => {
          const subject = docSnap.data().name;
          const option = document.createElement('option');
          option.value = subject;
          option.textContent = subject;
          addSubjectSelect.appendChild(option);
        });
      });

      // 勉強時間を追加する処理
      addRecordButton.addEventListener('click', async () => {
        const subject = addSubjectSelect.value;
        const startTime = addStartTime.value;
        const endTime = addEndTime.value;
        const pausedMinutes = parseInt(document.getElementById('addPausedMinutes').value) || 0; // 追加

        if (!subject || !startTime || !endTime) {
          alert('すべての項目を入力してください');
          return;
        }

        const start = new Date(startTime);
        const end = new Date(endTime);

        if (start >= end) {
          alert('開始時刻は終了時刻より前である必要があります');
          return;
        }

        try {
          await addDoc(recordsCollection, {
            subject: subject,
            startTime: Timestamp.fromDate(start),
            endTime: Timestamp.fromDate(end),
            pausedMs: pausedMinutes * 60 * 1000 // 休憩時間（分→ミリ秒）
          });
          alert('勉強時間を追加しました');
          addStartTime.value = '';
          addEndTime.value = '';
          addSubjectSelect.value = '';
          document.getElementById('addPausedMinutes').value = ''; // 追加
        } catch (error) {
          alert('勉強時間の追加に失敗しました: ' + error.message);
          console.error('勉強時間の追加エラー:', error);
        }
      });

      // Load subjects and listen for changes
      onSnapshot(qSubjects, (snapshot) => {
        subjectList.innerHTML = '';
        snapshot.forEach(docSnap => {
          const subject = docSnap.data().name;
          const li = document.createElement('li');
          li.textContent = subject;
          li.addEventListener('click', () => {
            subjectInput.value = subject;
          });
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = '削除';
          deleteBtn.addEventListener('click', async () => {
            if(confirm(`科目「${subject}」を削除しますか？`)){
              await deleteDoc(doc(db, 'subjects', docSnap.id));
            }
          });
          li.appendChild(deleteBtn);
          subjectList.appendChild(li);
        });
      });

      // Add new subject
      addSubjectButton.addEventListener('click', async () => {
        const newSubject = addSubjectInput.value.trim();
        if(newSubject === '') {
          alert('科目名を入力してください');
          return;
        }
        try {
          const qExisting = query(subjectsCollection, where('name', '==', newSubject));
          const existingSnapshot = await getDocs(qExisting);
          if (!existingSnapshot.empty) {
            alert('その科目は既に存在します');
            return;
          }
          await addDoc(subjectsCollection, { name: newSubject });
          addSubjectInput.value = '';
        } catch (error) {
          alert('科目の追加に失敗しました: ' + error.message);
          console.error('科目の追加エラー:', error);
        }
      });

      // Start timer
      startButton.addEventListener('click', () => {
        currentStartTime = new Date();
        totalPausedMs = 0;
        pauseStartTime = null;
        currentPausedMs = 0;
        startButton.disabled = true;
        endButton.disabled = false;
        pauseButton.disabled = false;
        resumeButton.style.display = 'none';
        pauseButton.style.display = '';
        updateDisplay();
        endTimeInput.value = '';

        // ▼▼ ローカルストレージに保存 ▼▼
        localStorage.setItem('studyTimer_currentStartTime', currentStartTime.toISOString());
        localStorage.setItem('studyTimer_subject', subjectInput.value.trim());
        localStorage.setItem('studyTimer_totalPausedMs', totalPausedMs);
        localStorage.removeItem('studyTimer_pauseStartTime');
        // ▲▲ ローカルストレージに保存 ▲▲

        if (elapsedTimerId) clearInterval(elapsedTimerId);
        if (pauseTimerId) clearInterval(pauseTimerId);
        elapsedTimerId = setInterval(updateDisplay, 1000);
      });

      // 休憩ボタン
      pauseButton.addEventListener('click', () => {
        if (!currentStartTime || pauseStartTime) return;
        pauseStartTime = new Date();
        currentPausedMs = 0;
        pauseButton.style.display = 'none';
        resumeButton.style.display = '';
        // ▼▼ 休憩開始時刻を保存 ▼▼
        localStorage.setItem('studyTimer_pauseStartTime', pauseStartTime.toISOString());
        // ▲▲
        if (elapsedTimerId) clearInterval(elapsedTimerId);
        if (pauseTimerId) clearInterval(pauseTimerId);
        pauseTimerId = setInterval(() => {
          updateDisplay();
        }, 1000);
      });

      // 休憩終了ボタン
      resumeButton.addEventListener('click', () => {
        if (!pauseStartTime) return;
        const now = new Date();
        const paused = now - pauseStartTime;
        totalPausedMs += paused;
        pauseStartTime = null;
        currentPausedMs = 0;
        resumeButton.style.display = 'none';
        pauseButton.style.display = '';
        // ▼▼ 休憩終了時、休憩開始時刻を削除・合計を保存 ▼▼
        localStorage.removeItem('studyTimer_pauseStartTime');
        localStorage.setItem('studyTimer_totalPausedMs', totalPausedMs);
        // ▲▲
        if (pauseTimerId) clearInterval(pauseTimerId);
        if (elapsedTimerId) clearInterval(elapsedTimerId);
        elapsedTimerId = setInterval(updateDisplay, 1000);
        updateDisplay();
      });

      // 表示更新（通常表示）
      function updateDisplay() {
        if (!currentStartTime) {
          startTimeDisplay.textContent = '';
          return;
        }
        const now = new Date();
        let elapsedMs = now - currentStartTime - totalPausedMs;
        let pausedMs = 0;
        if (pauseStartTime) {
          pausedMs = now - pauseStartTime;
          elapsedMs -= pausedMs;
        }
        const elapsedSec = Math.floor(elapsedMs / 1000);
        const pausedSec = Math.floor((totalPausedMs + pausedMs) / 1000);

        // 経過時間
        const h = Math.floor(elapsedSec / 3600);
        const m = Math.floor((elapsedSec % 3600) / 60);
        const s = elapsedSec % 60;
        let elapsedStr = '';
        if (h > 0) elapsedStr += `${h}時間`;
        if (m > 0 || h > 0) elapsedStr += `${m}分`;
        elapsedStr += `${s}秒`;

        // 休憩時間
        let pausedStr = '';
        if (pausedSec > 0) {
          const ph = Math.floor(pausedSec / 3600);
          const pm = Math.floor((pausedSec % 3600) / 60);
          const ps = pausedSec % 60;
          if (ph > 0) pausedStr += `${ph}時間`;
          if (pm > 0 || ph > 0) pausedStr += `${pm}分`;
          pausedStr += `${ps}秒`;
        }

        if (pauseStartTime) {
          startTimeDisplay.textContent = `開始: ${currentStartTime.toLocaleTimeString()}　経過: ${elapsedStr}　休憩中: ${pausedStr}`;
        } else if (pausedSec > 0) {
          startTimeDisplay.textContent = `開始: ${currentStartTime.toLocaleTimeString()}　経過: ${elapsedStr}　休憩合計: ${pausedStr}`;
        } else {
          startTimeDisplay.textContent = `開始: ${currentStartTime.toLocaleTimeString()}　経過: ${elapsedStr}`;
        }
      }

      // End timer and record
      endButton.addEventListener('click', async () => {
        if (!currentStartTime) {
          alert('「開始」ボタンを押して時間を計測してください。');
          return;
        }
        let endTime = new Date();
        if (pauseStartTime) {
          // 休憩中に終了した場合、休憩分も加算
          totalPausedMs += endTime - pauseStartTime;
          pauseStartTime = null;
        }
        endTimeInput.value = endTime.toISOString().slice(0, 16).replace('T', ' ');
        const subject = subjectInput.value.trim();
        if(subject === '') {
          alert('科目を入力してください');
          return;
        }
        try {
          await addDoc(recordsCollection, {
            subject: subject,
            startTime: Timestamp.fromDate(currentStartTime),
            endTime: Timestamp.fromDate(endTime),
            pausedMs: totalPausedMs // 休憩合計時間も保存
          });

          // ▼▼ ここから修正 ▼▼
          const durationMinutes = (endTime - currentStartTime) / 1000 / 60;
          const pausedMinutes = totalPausedMs ? Math.floor(totalPausedMs / 1000 / 60) : 0;
          const realMinutes = durationMinutes - pausedMinutes;
          const realSeconds = Math.floor((durationMinutes - pausedMinutes) * 60);

          let realDisplay = '';
          if (realMinutes < 1) {
            // 1分未満 → 秒のみ
            realDisplay = `${realSeconds}秒`;
          } else if (realMinutes < 60) {
            // 1時間未満 → 分と秒
            const min = Math.floor(realMinutes);
            const sec = realSeconds - min * 60;
            realDisplay = `${min}分${sec}秒`;
          } else {
            // 1時間以上 → 時間と分
            const hour = Math.floor(realMinutes / 60);
            const min = Math.floor(realMinutes % 60);
            realDisplay = `${hour}時間${min}分`;
          }
          alert(`お疲れさまでした。\nあなたは${realDisplay}勉強しました。`);
          // ▲▲ ここまで修正 ▲▲

          subjectInput.value = '';
          startTimeDisplay.textContent = '';
          currentStartTime = null;
          endTimeInput.value = '';
          if (elapsedTimerId) {
            clearInterval(elapsedTimerId);
            elapsedTimerId = null;
          }
          if (pauseTimerId) {
            clearInterval(pauseTimerId);
            pauseTimerId = null;
          }
          startButton.disabled = false;
          endButton.disabled = true;
          pauseButton.disabled = true;
          resumeButton.style.display = 'none';
          pauseButton.style.display = '';
          // ▼▼ ローカルストレージをクリア ▼▼
          localStorage.removeItem('studyTimer_currentStartTime');
          localStorage.removeItem('studyTimer_subject');
          localStorage.removeItem('studyTimer_pauseStartTime');
          localStorage.removeItem('studyTimer_totalPausedMs');
          // ▲▲ ローカルストレージをクリア ▲▲
        } catch (e) {
          alert('記録の追加に失敗しました: ' + e.message);
        }
      });

      // 記録のリアルタイム表示・グラフ・テーブル
      const qRecords = query(recordsCollection, orderBy('startTime', 'desc'));
      onSnapshot(qRecords, (snapshot) => {
        // 記録一覧
        recordList.innerHTML = '';
        allRecords.length = 0;
        snapshot.forEach(docSnap => {
          allRecords.push(docSnap);
        });

        // ここで最新5件だけ表示
        const recordsToShow = allRecords.slice(0, 5);
        const table = document.createElement('table');
        table.style.width = '100%';
        table.innerHTML = `
          <thead>
            <tr>
              <th>科目</th>
              <th>開始</th>
              <th>終了</th>
              <th>実勉強</th>
              <th>合計</th>
              <th>休憩</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');
        recordsToShow.forEach(docSnap => {
          const data = docSnap.data();
          const start = data.startTime.toDate();
          const end = data.endTime.toDate();
          const durationMinutes = (end - start) / 1000 / 60;
          const pausedMinutes = data.pausedMs ? Math.floor(data.pausedMs / 1000 / 60) : 0;
          const realMinutes = durationMinutes - pausedMinutes;
          const subject = data.subject;

          const realDisplay = realMinutes < 60 ? `${Math.floor(realMinutes)}分` : `${(realMinutes / 60).toFixed(2)}時間`;
          const totalDisplay = durationMinutes < 60 ? `${Math.floor(durationMinutes)}分` : `${(durationMinutes / 60).toFixed(2)}時間`;
          const pausedDisplay = pausedMinutes > 0 ? `${pausedMinutes}分` : '0分';

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${subject}</td>
            <td>${start.toLocaleString()}</td>
            <td>${end.toLocaleString()}</td>
            <td>${realDisplay}</td>
            <td>${totalDisplay}</td>
            <td>${pausedDisplay}</td>
            <td></td>
          `;
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = '削除';
          deleteBtn.addEventListener('click', async () => {
            if(confirm('この記録を削除しますか？')){
              await deleteDoc(doc(db, 'studyRecords', docSnap.id));
            }
          });
          tr.lastElementChild.appendChild(deleteBtn);
          tbody.appendChild(tr);
        });
        recordList.appendChild(table);

        // 「もっと見る」ボタンの表示制御
        if (allRecords.length > 5) {
          showMoreRecordsButton.style.display = '';
        } else {
          showMoreRecordsButton.style.display = 'none';
        }

        // グラフ描画
        const dateTotals = {};
        allRecords.forEach(docSnap => {
          const data = docSnap.data();
          const start = data.startTime.toDate();
          const end = data.endTime.toDate();
          const dateStr = start.toISOString().slice(0, 10);
          const durationMinutes = (end - start) / 1000 / 60;
          const pausedMinutes = data.pausedMs ? data.pausedMs / 1000 / 60 : 0;
          const realMinutes = durationMinutes - pausedMinutes;
          if (!dateTotals[dateStr]) dateTotals[dateStr] = 0;
          dateTotals[dateStr] += realMinutes / 60; // 時間単位
        });
        const chartLabels = Object.keys(dateTotals).sort((a, b) => new Date(a) - new Date(b));
        const chartData = chartLabels.map(date => dateTotals[date]);

        if (studyChart) {
          studyChart.data.labels = chartLabels;
          studyChart.data.datasets[0].data = chartData;
          studyChart.update();
        } else {
          studyChart = new Chart(studyChartCtx, {
            type: 'bar',
            data: {
              labels: chartLabels,
              datasets: [{
                label: '実勉強時間（時間）',
                data: chartData,
                backgroundColor: '#4CAF50'
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false }
              },
              scales: {
                y: { beginAtZero: true, title: { display: true, text: '時間' } }
              }
            }
          });
        }

        // テーブル描画
        const summary = {};
        const pausedSummary = {};
        allRecords.forEach(docSnap => {
          const data = docSnap.data();
          const start = data.startTime.toDate();
          const end = data.endTime.toDate();
          const dateStr = start.toISOString().slice(0, 10);
          const subject = data.subject;
          const durationMinutes = (end - start) / 1000 / 60;
          const pausedMinutes = data.pausedMs ? data.pausedMs / 1000 / 60 : 0;
          if (!summary[dateStr]) summary[dateStr] = {};
          if (!pausedSummary[dateStr]) pausedSummary[dateStr] = {};
          if (!summary[dateStr][subject]) summary[dateStr][subject] = 0;
          if (!pausedSummary[dateStr][subject]) pausedSummary[dateStr][subject] = 0;
          summary[dateStr][subject] += durationMinutes;
          pausedSummary[dateStr][subject] += pausedMinutes;
        });

        summaryTableBody.innerHTML = '';
        Object.keys(summary)
          .sort((a, b) => new Date(a) - new Date(b))
          .forEach(date => {
            Object.keys(summary[date]).forEach(subject => {
              const total = summary[date][subject];
              const paused = pausedSummary[date][subject];
              const real = total - paused;
              const realDisplay = real < 60 ? `${Math.floor(real)}分` : `${(real / 60).toFixed(2)}時間`;
              const totalDisplay = total < 60 ? `${Math.floor(total)}分` : `${(total / 60).toFixed(2)}時間`;
              const pausedDisplay = paused > 0 ? `${Math.round(paused)}分` : '0分';
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${date}</td>
                <td>${subject}</td>
                <td>${realDisplay}</td>
                <td>${totalDisplay}</td>
                <td>${pausedDisplay}</td>
              `;
              summaryTableBody.appendChild(tr);
            });
          });

        // ▼▼ ここを追加 ▼▼
        updateMonthOptions(allRecords);
        // デフォルトは最新月
        if (monthSelect.options.length > 0 && !monthSelect.value) {
          monthSelect.value = monthSelect.options[monthSelect.options.length - 1].value;
        }
        renderMonthlySummary(allRecords, monthSelect.value);
      });

      function renderRecordList() {
        recordList.innerHTML = '';
        const recordsToShow = showingAll ? allRecords : allRecords.slice(0, 5);
        recordsToShow.forEach(docSnap => {
          const data = docSnap.data();
          const start = data.startTime.toDate();
          const end = data.endTime.toDate();
          const durationMinutes = (end - start) / 1000 / 60;
          const pausedMinutes = data.pausedMs ? Math.floor(data.pausedMs / 1000 / 60) : 0;
          const realMinutes = durationMinutes - pausedMinutes;
          const subject = data.subject;

          // 表示用
          const realDisplay = realMinutes < 60 ? `${Math.floor(realMinutes)}分` : `${(realMinutes / 60).toFixed(2)}時間`;
          const totalDisplay = durationMinutes < 60 ? `${Math.floor(durationMinutes)}分` : `${(durationMinutes / 60).toFixed(2)}時間`;
          const pausedDisplay = pausedMinutes > 0 ? `${pausedMinutes}分` : '0分';

          const li = document.createElement('li');
          li.textContent = `${subject} : ${start.toLocaleString()} 〜 ${end.toLocaleString()}　実勉強: ${realDisplay} ／ 合計: ${totalDisplay} ／ 休憩: ${pausedDisplay}`;
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = '削除';
          deleteBtn.addEventListener('click', async () => {
            if(confirm('この記録を削除しますか？')){
              await deleteDoc(doc(db, 'studyRecords', docSnap.id));
            }
          });
          li.appendChild(deleteBtn);
          recordList.appendChild(li);
        });
      }

      showMoreRecordsButton.addEventListener('click', () => {
        showingAll = !showingAll;
        renderRecordList();
        showMoreRecordsButton.textContent = showingAll ? '閉じる' : 'もっと見る';
      });

      // 月間総勉強時間の表示
      const monthSelect = document.getElementById('monthSelect');
      const monthlySummaryBody = document.getElementById('monthlySummaryBody');

      // 月選択肢の生成
      for (let m = 0; m < 12; m++) {
        const monthOption = document.createElement('option');
        monthOption.value = m;
        monthOption.textContent = `${m + 1}月`;
        monthSelect.appendChild(monthOption);
      }

      // 月間総勉強時間の取得と表示
      monthSelect.addEventListener('change', async () => {
        const selectedMonth = parseInt(monthSelect.value);
        if (isNaN(selectedMonth)) return;

        // 1日から月末までの範囲を取得
        const startOfMonth = new Date(new Date().getFullYear(), selectedMonth, 1);
        const endOfMonth = new Date(new Date().getFullYear(), selectedMonth + 1, 0, 23, 59, 59);

        const qMonthlySummary = query(recordsCollection, where('startTime', '>=', Timestamp.fromDate(startOfMonth)), where('endTime', '<=', Timestamp.fromDate(endOfMonth)), orderBy('subject'));
        onSnapshot(qMonthlySummary, (snapshot) => {
          monthlySummaryBody.innerHTML = '';
          const monthlyTotals = {};
          snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const subject = data.subject;
            const start = data.startTime.toDate();
            const end = data.endTime.toDate();
            const durationMinutes = (end - start) / 1000 / 60;
            if (!monthlyTotals[subject]) monthlyTotals[subject] = 0;
            monthlyTotals[subject] += durationMinutes;
          });

          monthlySummaryBody.innerHTML = '';
          Object.keys(monthlyTotals).sort().forEach(subject => {
            const total = monthlyTotals[subject];
            const paused = subjectPaused[subject];
            const real = total - paused;
            const realDisplay = real < 60 ? `${Math.floor(real)}分` : `${(real / 60).toFixed(2)}時間`;
            const totalDisplay = total < 60 ? `${Math.floor(total)}分` : `${(total / 60).toFixed(2)}時間`;
            const pausedDisplay = paused > 0 ? `${Math.round(paused)}分` : '0分';
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${subject}</td>
              <td>${realDisplay}</td>
              <td>${totalDisplay}</td>
              <td>${pausedDisplay}</td>
            `;
            monthlySummaryBody.appendChild(tr);
          });
        });
      });

      // 初期表示は今月に設定
      const now = new Date();
      monthSelect.value = now.getMonth();
      monthSelect.dispatchEvent(new Event('change'));

      // 月選択肢をセット
      function updateMonthOptions(allRecords) {
        const months = new Set();
        allRecords.forEach(docSnap => {
          const data = docSnap.data();
          const start = data.startTime.toDate();
          const ym = `${start.getFullYear()}-${String(start.getMonth() + 1).padStart(2, '0')}`;
          months.add(ym);
        });
        // 降順（新しい順）でソート
        const sortedMonths = Array.from(months).sort((a, b) => new Date(b + '-01') - new Date(a + '-01'));

        // 現在の年月
        const now = new Date();
        const currentYm = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

        // 先頭に今月を追加（重複しないように）
        const monthList = [currentYm, ...sortedMonths.filter(m => m !== currentYm)];

        monthSelect.innerHTML = '';
        monthList.forEach(ym => {
          const option = document.createElement('option');
          option.value = ym;
          option.textContent = ym.replace('-', '年') + '月';
          monthSelect.appendChild(option);
        });
        // 今月を選択状態に
        monthSelect.value = currentYm;
      }

      // 月ごとの科目別合計を計算して表に描画
      function renderMonthlySummary(allRecords, selectedMonth) {
        const subjectTotals = {};
        const subjectPaused = {};
        allRecords.forEach(docSnap => {
          const data = docSnap.data();
          const start = data.startTime.toDate();
          const ym = `${start.getFullYear()}-${String(start.getMonth() + 1).padStart(2, '0')}`;
          if (ym !== selectedMonth) return;
          const subject = data.subject;
          const end = data.endTime.toDate();
          const durationMinutes = (end - start) / 1000 / 60;
          const pausedMinutes = data.pausedMs ? data.pausedMs / 1000 / 60 : 0;
          if (!subjectTotals[subject]) subjectTotals[subject] = 0;
          if (!subjectPaused[subject]) subjectPaused[subject] = 0;
          subjectTotals[subject] += durationMinutes;
          subjectPaused[subject] += pausedMinutes;
        });
        monthlySummaryBody.innerHTML = '';
        Object.keys(subjectTotals).sort().forEach(subject => {
          const total = subjectTotals[subject];
          const paused = subjectPaused[subject];
          const real = total - paused;
          const realDisplay = real < 60 ? `${Math.floor(real)}分` : `${(real / 60).toFixed(2)}時間`;
          const totalDisplay = total < 60 ? `${Math.floor(total)}分` : `${(total / 60).toFixed(2)}時間`;
          const pausedDisplay = paused > 0 ? `${Math.round(paused)}分` : '0分';
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${subject}</td>
            <td>${realDisplay}</td>
            <td>${totalDisplay}</td>
            <td>${pausedDisplay}</td>
          `;
          monthlySummaryBody.appendChild(tr);
        });
      }

      // 月選択時に再描画
      monthSelect.addEventListener('change', () => {
        renderMonthlySummary(allRecords, monthSelect.value);
      });

      // ユーザーの認証状態を監視
      onAuthStateChanged(auth, user => {
        if (!user) {
          // 未ログインならmain.htmlへリダイレクト
          window.location.href = "main.html";
          return;
        }

        // ▼▼ ここから追加 ▼▼
        // ログイン時刻をlocalStorageに保存
        if (!localStorage.getItem('loginTime')) {
          localStorage.setItem('loginTime', Date.now());
        }

        // 12時間経過チェック
        function checkLoginTimeout() {
          const loginTime = parseInt(localStorage.getItem('loginTime'), 10);
          if (Date.now() - loginTime > 12 * 60 * 60 * 1000) { // 12時間
            alert('12時間経過したため自動的にログアウトします。');
            auth.signOut();
            localStorage.removeItem('loginTime');
          }
        }

        // 1分ごとにチェック
        setInterval(checkLoginTimeout, 60 * 1000);
        checkLoginTimeout();
        // ▲▲ ここまで追加 ▲▲
      });

      const fullscreenTimer = document.getElementById('fullscreenTimer');
      const fullscreenElapsed = document.getElementById('fullscreenElapsed');
      const fullscreenNow = document.getElementById('fullscreenNow'); // 追加
      const exitFullscreenTimer = document.getElementById('exitFullscreenTimer');
      const showFullscreenBtn = document.createElement('button');
      showFullscreenBtn.textContent = '全画面で経過時間表示';
      showFullscreenBtn.style.marginLeft = '10px';
      recordControlDiv.appendChild(showFullscreenBtn);

      let fullscreenTimerInterval = null;

      showFullscreenBtn.addEventListener('click', () => {
        fullscreenTimer.style.display = 'flex';
        updateFullscreenElapsed();
        if (fullscreenTimerInterval) clearInterval(fullscreenTimerInterval);
        fullscreenTimerInterval = setInterval(updateFullscreenElapsed, 1000);
      });

      exitFullscreenTimer.addEventListener('click', () => {
        fullscreenTimer.style.display = 'none';
        if (fullscreenTimerInterval) clearInterval(fullscreenTimerInterval);
      });

      // --- フルスクリーン表示は経過時間＋現時刻（時:分） ---
      function updateFullscreenElapsed() {
        // 現時刻の表示（時:分のみ）
        const nowDate = new Date();
        const hh = String(nowDate.getHours()).padStart(2, '0');
        const mm = String(nowDate.getMinutes()).padStart(2, '0');
        fullscreenNow.textContent = `${hh}:${mm}`;

        // 経過時間の表示
        if (!currentStartTime) {
          fullscreenElapsed.textContent = '計測中ではありません';
          return;
        }
        const now = new Date();
        let elapsedMs = now - currentStartTime - totalPausedMs;
        if (pauseStartTime) {
          elapsedMs -= (now - pauseStartTime);
        }
        const elapsedSec = Math.floor(elapsedMs / 1000);
        const h = Math.floor(elapsedSec / 3600);
        const m = Math.floor((elapsedSec % 3600) / 60);
        const s = elapsedSec % 60;
        let elapsedStr = '';
        if (h > 0) elapsedStr += `${h}時間`;
        if (m > 0 || h > 0) elapsedStr += `${m}分`;
        elapsedStr += `${s}秒`;
        fullscreenElapsed.textContent = elapsedStr;
      }

      // --- 通知許可リクエスト関数 ---
      async function requestNotificationPermission() {
        if ('Notification' in window && Notification.permission !== 'granted') {
          await Notification.requestPermission();
        }
      }

      // --- 25分ごと通知タイマー ---
      let pomodoroInterval = null;
      let lastPomodoroElapsed = 0;

      function startPomodoroNotification() {
        if ('Notification' in window && Notification.permission === 'granted') {
          if (pomodoroInterval) clearInterval(pomodoroInterval);
          lastPomodoroElapsed = 0;
          pomodoroInterval = setInterval(() => {
            if (!currentStartTime) return;
            const now = new Date();
            let elapsedMs = now - currentStartTime - totalPausedMs;
            if (pauseStartTime) {
              elapsedMs -= (now - pauseStartTime);
            }
            const elapsedMin = Math.floor(elapsedMs / 1000 / 60);
            // 25分ごとに通知（例: 25, 50, 75...分）
            if (elapsedMin > 0 && elapsedMin % 25 === 0 && elapsedMin !== lastPomodoroElapsed) {
              // 経過時間の文字列
              const h = Math.floor(elapsedMin / 60);
              const m = elapsedMin % 60;
              let elapsedStr = '';
              if (h > 0) elapsedStr += `${h}時間`;
              if (m > 0 || h > 0) elapsedStr += `${m}分`;
              // 通知
              new Notification('25分経過', {
                body: `経過時間: ${elapsedStr}`
              });
              lastPomodoroElapsed = elapsedMin;
            }
          }, 10000); // 10秒ごとにチェック
        }
      }

      function stopPomodoroNotification() {
        if (pomodoroInterval) clearInterval(pomodoroInterval);
        pomodoroInterval = null;
        lastPomodoroElapsed = 0;
      }

      // --- 開始・終了ボタンに通知処理を追加 ---
      startButton.addEventListener('click', async () => {
        await requestNotificationPermission();
        startPomodoroNotification();
      });

      endButton.addEventListener('click', () => {
        stopPomodoroNotification();
      });
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <h1>勉強時間記録</h1>

  <div class="input-area">
    <div>
      <label for="subject">科目:</label>
      <input type="text" id="subject">
    </div>
    <div>
      <label for="startTime">開始時刻:</label>
      <input type="datetime-local" id="startTime" style="display: none;">
    </div>
    <div>
      <label for="endTime">終了時刻:</label>
      <input type="datetime-local" id="endTime">
    </div>
  </div>

  <div class="add-record">
    <h2>勉強時間を追加</h2>
    <div>
      <label for="addSubjectSelect">科目:</label>
      <select id="addSubjectSelect"></select>
    </div>
    <div>
      <label for="addStartTime">開始時刻:</label>
      <input type="datetime-local" id="addStartTime">
    </div>
    <div>
      <label for="addEndTime">終了時刻:</label>
      <input type="datetime-local" id="addEndTime">
    </div>
    <div>
      <label for="addPausedMinutes">休憩時間:</label>
      <input type="number" id="addPausedMinutes" min="0" inputmode="numeric" pattern="[0-9]*" placeholder="分">
    </div>
    <button id="addRecordButton">記録を追加</button>
  </div>

  <div class="subject-management">
    <h2>科目管理</h2>
    <input type="text" id="addSubject" placeholder="新しい科目">
    <button id="addSubjectButton">追加</button>
    <h3>科目一覧</h3>
    <ul id="subjectList"></ul>
  </div>

  <h2>記録一覧</h2>
  <ul id="recordList"></ul>
  <button id="showMoreRecordsButton" style="display:none;">もっと見る</button>

  <div id="dailyTotal"></div>

  <!-- ▼▼▼ ここを移動 ▼▼▼ -->
  <div id="monthlySummaryArea" class="input-area">
    <h2>科目別 月間総勉強時間</h2>
    <label for="monthSelect">月選択：</label>
    <select id="monthSelect"></select>
    <table>
      <thead>
        <tr>
          <th>科目</th>
          <th>合計時間</th>
        </tr>
      </thead>
      <tbody id="monthlySummaryBody"></tbody>
    </table>
  </div>
  <!-- ▲▲▲ ここを移動 ▲▲▲ -->

  <h2>勉強時間の推移</h2>
  <canvas id="studyChart"></canvas>

  <div id="summaryTable">
    <h2>科目別・日付別 合計勉強時間</h2>
    <table>
      <thead>
        <tr>
          <th>日付</th>
          <th>科目</th>
          <th>実勉強</th>
          <th>合計</th>
          <th>休憩</th>
        </tr>
      </thead>
      <tbody id="summaryTableBody">
      </tbody>
    </table>
  </div>

  <div id="fullscreenTimer" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:#222;color:#fff;z-index:9999;align-items:center;justify-content:center;flex-direction:column;">
    <div id="fullscreenNow" style="font-size:4vw;margin-bottom:2vw;"></div> <!-- 追加 -->
    <div id="fullscreenElapsed" style="font-size:8vw;font-weight:bold;"></div>
    <button id="exitFullscreenTimer" style="position:absolute;right:40px;bottom:40px;font-size:2vw;padding:1em 2em;">戻る</button>
  </div>

  <div style="text-align:center; margin: 40px 0 10px 0;">
    <button id="logoutButton" style="background:#e74c3c;color:#fff;padding:10px 30px;font-size:1.2em;border:none;border-radius:6px;cursor:pointer;">
      ログアウト
    </button>
  </div>

  <script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}

// ▼▼ ログアウトボタンの処理 ▼▼
document.getElementById('logoutButton').addEventListener('click', async () => {
  const { getAuth, signOut } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
  const auth = getAuth();
  await signOut(auth);
  localStorage.removeItem('loginTime');
});
  </script>
</body>
</html>